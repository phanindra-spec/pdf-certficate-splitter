<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Certificate Splitter - Cloud Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* VIEWER MODE */
        .viewer-mode {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .viewer-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            padding: 40px;
            text-align: center;
            max-width: 900px;
            width: 100%;
        }

        .certificate-viewer {
            width: 100%;
            max-width: 800px;
            min-height: 600px;
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            margin: 20px auto;
            background: white;
            position: relative;
        }

        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* GENERATOR MODE */
        .generator-mode {
            padding: 40px;
        }

        .setup-section {
            background: #f8fafc;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 1rem;
        }

        .form-group input[type="text"],
        .form-group input[type="url"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Monaco', 'Menlo', monospace;
            resize: vertical;
            min-height: 150px;
            transition: border-color 0.3s;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 2px solid #e2e8f0;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .status-panel {
            background: #f0f9ff;
            border: 1px solid #bfdbfe;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .status-icon {
            font-size: 1.5rem;
            width: 30px;
            text-align: center;
        }

        .results-section {
            background: #f0fdf4;
            border-radius: 15px;
            padding: 30px;
            border-left: 5px solid #10b981;
            margin-top: 30px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .results-table th,
        .results-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .results-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .results-table tbody tr:hover {
            background: #f8fafc;
        }

        .copy-btn {
            padding: 8px 15px;
            font-size: 12px;
            border-radius: 6px;
            background: #e0e7ff;
            color: #3730a3;
            border: none;
            cursor: pointer;
            margin-right: 5px;
        }

        .copy-btn:hover {
            background: #c7d2fe;
        }

        .url-display {
            font-family: monospace;
            font-size: 11px;
            background: #f8fafc;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .instructions {
            background: #fef7ed;
            border: 1px solid #fed7aa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .instructions h3 {
            color: #c2410c;
            margin-bottom: 15px;
        }

        .github-setup {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .github-setup h4 {
            color: #1e40af;
            margin-bottom: 15px;
        }

        .hidden {
            display: none;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 15px;
            color: #dc2626;
            margin: 15px 0;
        }

        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 15px;
            color: #166534;
            margin: 15px 0;
        }

        @media (max-width: 768px) {
            .generator-mode {
                padding: 20px;
            }
            
            .results-table {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- VIEWER MODE (for certificate recipients) -->
    <div id="viewerMode" class="viewer-mode">
        <div class="viewer-container">
            <h1>Your Certificate</h1>
            <p id="viewerWelcome">Loading your certificate...</p>
            
            <div class="certificate-viewer" id="certificateViewer">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Loading your certificate...</p>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="downloadUserCertificate()" id="downloadBtn" style="display: none;">
                    📄 Download Your Certificate
                </button>
                <button class="btn btn-secondary" onclick="shareCertificate()">
                    🔗 Share Certificate
                </button>
            </div>
        </div>
    </div>

    <!-- GENERATOR MODE (for certificate administrators) -->
    <div id="generatorMode" class="generator-mode">
        <div class="container">
            <div class="header">
                <h1>📄 Cloud PDF Certificate Splitter</h1>
                <p>Ultra-short URLs using GitHub-hosted master PDF - No storage limits!</p>
            </div>

            <div class="instructions">
                <h3>🚀 New Cloud-Based Approach - Much Better!</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                    <div>
                        <h4 style="color: #dc2626;">❌ Old Method Problems:</h4>
                        <ul style="color: #991b1b; font-size: 14px;">
                            <li>15,000+ character URLs</li>
                            <li>Email compatibility issues</li>
                            <li>Browser storage limits</li>
                            <li>Slow processing</li>
                        </ul>
                    </div>
                    <div>
                        <h4 style="color: #166534;">✅ New Method Benefits:</h4>
                        <ul style="color: #166534; font-size: 14px;">
                            <li>Under 200 character URLs</li>
                            <li>Works in all email clients</li>
                            <li>No storage limits</li>
                            <li>Lightning fast</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="github-setup">
                <h4>📋 Setup Instructions:</h4>
                <ol style="color: #1e3a8a; margin-left: 20px;">
                    <li><strong>Upload PDF to GitHub:</strong> Create <code>/certificates/</code> folder in your repo</li>
                    <li><strong>Upload your multi-page PDF:</strong> e.g., <code>graduation_certificates.pdf</code></li>
                    <li><strong>Get the GitHub URL:</strong> <code>https://username.github.io/repo/certificates/file.pdf</code></li>
                    <li><strong>Enter URL below</strong> along with participant mapping</li>
                </ol>
            </div>

            <div class="setup-section">
                <h3>🌐 Master PDF Configuration</h3>
                
                <div class="form-group">
                    <label>GitHub PDF URL (Master Certificate File)</label>
                    <input 
                        type="url" 
                        id="masterPdfUrl" 
                        placeholder="https://username.github.io/repository/certificates/graduation_certificates.pdf"
                        style="font-family: monospace; font-size: 14px;"
                    >
                    <small style="color: #6b7280; display: block; margin-top: 5px;">
                        💡 Must be a publicly accessible GitHub Pages URL
                    </small>
                </div>

                <button class="btn btn-secondary" onclick="testMasterPdf()">
                    🔍 Test Master PDF
                </button>
                
                <div id="pdfTestResult" class="hidden"></div>
            </div>

            <div class="setup-section">
                <h3>📊 Participant Mapping</h3>
                
                <div class="form-group">
                    <label>CSV Mapping (name,page_number)</label>
                    <textarea 
                        id="participantMapping" 
                        placeholder="John Doe,1&#10;Jane Smith,2&#10;Mike Johnson,3&#10;Sarah Wilson,4&#10;David Brown,5"
                        rows="8"
                    ></textarea>
                    <small style="color: #6b7280; display: block; margin-top: 5px;">
                        Format: <strong>name,page_number</strong> (one person per line)
                    </small>
                </div>
            </div>

            <div class="status-panel">
                <h3>📊 Status</h3>
                <div class="status-item">
                    <div class="status-icon" id="pdfStatusIcon">⏳</div>
                    <div>
                        <strong>Master PDF:</strong> 
                        <span id="pdfStatusText">Waiting for PDF URL...</span>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-icon" id="csvStatusIcon">⏳</div>
                    <div>
                        <strong>Participant Data:</strong> 
                        <span id="csvStatusText">Waiting for participant mapping...</span>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin: 30px 0;">
                <button class="btn btn-primary" id="generateBtn" onclick="generateCloudLinks()" disabled>
                    🚀 Generate Ultra-Short Links
                </button>
                <button class="btn btn-secondary" onclick="clearAll()">
                    🗑️ Clear All
                </button>
            </div>

            <div id="resultsSection" class="results-section hidden">
                <h3>🎉 Generated Ultra-Short Certificate Links</h3>
                <p>Each link is under 200 characters and works perfectly in email clients!</p>
                
                <div id="resultsSummary"></div>

                <div style="margin: 20px 0;">
                    <button class="btn btn-secondary" onclick="copyAllResults()">📋 Copy All Links</button>
                    <button class="btn btn-secondary" onclick="downloadResults()">💾 Download List</button>
                    <button class="btn btn-secondary" onclick="generateEmailTemplates()">📧 Email Templates</button>
                </div>

                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Page</th>
                            <th>Short URL</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let masterPdfUrl = '';
        let participantMappings = [];
        let generatedLinks = [];
        let currentMode = 'generator';
        let currentPdfDoc = null;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            determineMode();
            if (currentMode === 'viewer') {
                initViewerMode();
            } else {
                initGeneratorMode();
            }
        });

        function determineMode() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('pdf') && urlParams.has('page') && urlParams.has('name')) {
                currentMode = 'viewer';
            }
        }

        function initViewerMode() {
            document.getElementById('viewerMode').style.display = 'flex';
            document.getElementById('generatorMode').style.display = 'none';
            loadCertificateFromCloud();
        }

        function initGeneratorMode() {
            document.getElementById('generatorMode').style.display = 'block';
            document.getElementById('viewerMode').style.display = 'none';
            
            // Setup event listeners
            document.getElementById('masterPdfUrl').addEventListener('input', validateInputs);
            document.getElementById('participantMapping').addEventListener('input', validateInputs);
        }

        async function testMasterPdf() {
            const pdfUrl = document.getElementById('masterPdfUrl').value.trim();
            
            if (!pdfUrl) {
                showMessage('pdfTestResult', 'Please enter a PDF URL first', 'error');
                return;
            }

            if (!isValidGitHubUrl(pdfUrl)) {
                showMessage('pdfTestResult', 'Please use a valid GitHub Pages URL (https://username.github.io/...)', 'error');
                return;
            }

            try {
                updateStatus('pdf', '⏳', 'Testing PDF URL...');
                showMessage('pdfTestResult', 'Testing PDF accessibility...', 'info');

                const response = await fetch(pdfUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const arrayBuffer = await response.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                const pageCount = pdfDoc.getPageCount();

                masterPdfUrl = pdfUrl;
                currentPdfDoc = pdfDoc;

                updateStatus('pdf', '✅', `PDF loaded successfully - ${pageCount} pages`);
                showMessage('pdfTestResult', `✅ Success! PDF has ${pageCount} pages and is accessible.`, 'success');
                
                validateInputs();

            } catch (error) {
                console.error('PDF test failed:', error);
                updateStatus('pdf', '❌', 'PDF test failed');
                showMessage('pdfTestResult', `❌ Error: ${error.message}. Check URL and ensure GitHub Pages is enabled.`, 'error');
            }
        }

        function isValidGitHubUrl(url) {
            return url.startsWith('https://') && url.includes('github.io') && url.endsWith('.pdf');
        }

        function validateInputs() {
            const pdfUrl = document.getElementById('masterPdfUrl').value.trim();
            const mappingText = document.getElementById('participantMapping').value.trim();

            // Validate PDF
            const hasPdf = pdfUrl && masterPdfUrl === pdfUrl;
            
            // Validate and parse CSV
            let mappingsValid = false;
            if (mappingText) {
                try {
                    participantMappings = parseParticipantMapping(mappingText);
                    if (participantMappings.length > 0) {
                        mappingsValid = true;
                        updateStatus('csv', '✅', `${participantMappings.length} participants loaded`);
                    }
                } catch (error) {
                    updateStatus('csv', '❌', 'Invalid CSV format');
                    participantMappings = [];
                }
            } else {
                updateStatus('csv', '⏳', 'Waiting for participant mapping...');
            }

            // Enable/disable generate button
            document.getElementById('generateBtn').disabled = !(hasPdf && mappingsValid);
        }

        function parseParticipantMapping(csvText) {
            const lines = csvText.trim().split('\n').filter(line => line.trim());
            const mappings = [];

            for (let line of lines) {
                const parts = line.split(',').map(p => p.trim());
                if (parts.length >= 2) {
                    const name = parts[0];
                    const pageNumber = parseInt(parts[1]);
                    
                    if (name && !isNaN(pageNumber) && pageNumber > 0) {
                        mappings.push({
                            name: name,
                            pageNumber: pageNumber,
                            id: generateId()
                        });
                    }
                }
            }

            if (mappings.length === 0) {
                throw new Error('No valid mappings found');
            }

            return mappings;
        }

        function generateId() {
            return Math.random().toString(36).substr(2, 8);
        }

        function updateStatus(type, icon, text) {
            document.getElementById(`${type}StatusIcon`).textContent = icon;
            document.getElementById(`${type}StatusText`).textContent = text;
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = type === 'error' ? 'error-message' : 
                              type === 'success' ? 'success-message' : 
                              'status-panel';
            element.textContent = message;
            element.classList.remove('hidden');
        }

        async function generateCloudLinks() {
            if (!masterPdfUrl || participantMappings.length === 0) {
                alert('Please test the PDF URL and add participant mappings first');
                return;
            }

            try {
                const baseUrl = window.location.href.split('?')[0];
                generatedLinks = [];

                // Validate page numbers against PDF
                const maxPage = currentPdfDoc ? currentPdfDoc.getPageCount() : 999;

                for (let mapping of participantMappings) {
                    if (mapping.pageNumber > maxPage) {
                        console.warn(`Page ${mapping.pageNumber} doesn't exist for ${mapping.name} (PDF has ${maxPage} pages)`);
                        continue;
                    }

                    // Create ultra-short URL
                    const shortUrl = `${baseUrl}?pdf=${encodeURIComponent(masterPdfUrl)}&page=${mapping.pageNumber}&name=${encodeURIComponent(mapping.name)}`;

                    generatedLinks.push({
                        name: mapping.name,
                        pageNumber: mapping.pageNumber,
                        id: mapping.id,
                        url: shortUrl,
                        urlLength: shortUrl.length
                    });
                }

                displayResults();

            } catch (error) {
                console.error('Error generating links:', error);
                alert('Error generating links: ' + error.message);
            }
        }

        function displayResults() {
            const resultsSection = document.getElementById('resultsSection');
            const resultsBody = document.getElementById('resultsBody');
            const resultsSummary = document.getElementById('resultsSummary');

            // Calculate statistics
            const avgUrlLength = generatedLinks.reduce((sum, link) => sum + link.urlLength, 0) / generatedLinks.length;
            const maxUrlLength = Math.max(...generatedLinks.map(link => link.urlLength));
            const minUrlLength = Math.min(...generatedLinks.map(link => link.urlLength));

            // Display summary
            resultsSummary.innerHTML = `
                <div style="background: #f8fafc; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #059669;">📊 Ultra-Short URL Statistics:</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 14px;">
                        <div><strong>Total Links:</strong> ${generatedLinks.length}</div>
                        <div><strong>Average URL Length:</strong> ${Math.round(avgUrlLength)} chars</div>
                        <div><strong>Shortest URL:</strong> ${minUrlLength} chars</div>
                        <div><strong>Longest URL:</strong> ${maxUrlLength} chars</div>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px; color: #166534;">
                        ✅ <strong>Perfect!</strong> All URLs are ultra-short and will work flawlessly in email clients, messaging apps, and social media.
                    </div>
                </div>
            `;

            // Display results table
            resultsBody.innerHTML = generatedLinks.map(link => `
                <tr>
                    <td><strong>${link.name}</strong></td>
                    <td>${link.pageNumber}</td>
                    <td>
                        <div class="url-display" title="${link.url}">
                            ${link.url}
                        </div>
                        <small style="color: #059669; font-weight: 600;">
                            ✅ ${link.urlLength} characters
                        </small>
                    </td>
                    <td>
                        <button class="copy-btn" onclick="copyToClipboard('${link.url.replace(/'/g, "\\'")}')">📋 Copy</button>
                        <button class="copy-btn" onclick="testLink('${link.url.replace(/'/g, "\\'")}')">👁️ Test</button>
                    </td>
                </tr>
            `).join('');

            resultsSection.classList.remove('hidden');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                event.target.textContent = '✅ Copied!';
                event.target.style.background = '#10b981';
                event.target.style.color = 'white';
                setTimeout(() => {
                    event.target.textContent = '📋 Copy';
                    event.target.style.background = '';
                    event.target.style.color = '';
                }, 2000);
            });
        }

        function testLink(url) {
            window.open(url, '_blank');
        }

        function copyAllResults() {
            const allLinks = generatedLinks.map(link => 
                `${link.name}: ${link.url}`
            ).join('\n\n');
            
            copyToClipboard(allLinks);
        }

        function downloadResults() {
            const content = [
                'Ultra-Short Certificate Links (Cloud-Based)',
                '=' .repeat(50),
                `Generated on: ${new Date().toLocaleDateString()}`,
                `Master PDF: ${masterPdfUrl}`,
                `Total certificates: ${generatedLinks.length}`,
                `Average URL length: ${Math.round(generatedLinks.reduce((sum, link) => sum + link.urlLength, 0) / generatedLinks.length)} characters`,
                '',
                'PERSONALIZED CERTIFICATE LINKS:',
                '',
                ...generatedLinks.map(link => 
                    `${link.name} (Page ${link.pageNumber}): ${link.url}`
                ),
                '',
                'Instructions for recipients:',
                '1. Click your personalized link',
                '2. Your certificate page will load from the cloud',
                '3. Click "Download Your Certificate" to save as PDF',
                '',
                'Benefits of this cloud-based approach:',
                '• Ultra-short URLs (under 200 characters)',
                '• Perfect email and messaging app compatibility', 
                '• No browser storage limitations',
                '• Fast and reliable certificate delivery',
                '• Easy to update certificates by replacing master PDF'
            ].join('\n');
            
            const blob = new Blob([content], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ultra_short_certificate_links.txt';
            link.click();
        }

        function generateEmailTemplates() {
            const templates = generatedLinks.map(link => `
=== EMAIL FOR: ${link.name.toUpperCase()} ===

Subject: 🎉 Your Certificate is Ready - Ultra-Fast Download!

Hi ${link.name},

Great news! Your certificate is ready for instant viewing and download.

🏆 Your Certificate Link: ${link.url}

✨ What makes this special:
• Instant loading from the cloud
• Works perfectly in email clients
• Mobile-friendly viewing
• One-click PDF download

Instructions:
1. Click the link above
2. Your certificate (page ${link.pageNumber}) loads instantly
3. Click "Download Your Certificate" to save as PDF

This link is personalized for you and loads your specific certificate page.

Best regards,
[Your Organization Name]

---
            `).join('\n');
            
            const blob = new Blob([templates], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ultra_short_email_templates.txt';
            link.click();
        }

        function clearAll() {
            document.getElementById('masterPdfUrl').value = '';
            document.getElementById('participantMapping').value = '';
            document.getElementById('pdfTestResult').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            
            masterPdfUrl = '';
            participantMappings = [];
            generatedLinks = [];
            currentPdfDoc = null;
            
            updateStatus('pdf', '⏳', 'Waiting for PDF URL...');
            updateStatus('csv', '⏳', 'Waiting for participant mapping...');
            
            document.getElementById('generateBtn').disabled = true;
        }

        // VIEWER MODE FUNCTIONS
        async function loadCertificateFromCloud() {
            const urlParams = new URLSearchParams(window.location.search);
            
            try {
                const pdfUrl = urlParams.get('pdf');
                const pageNumber = parseInt(urlParams.get('page'));
                const recipientName = urlParams.get('name');

                if (!pdfUrl || !pageNumber || !recipientName) {
                    throw new Error('Invalid certificate link - missing required parameters');
                }

                document.getElementById('viewerWelcome').textContent = 
                    `Hello ${recipientName}! Loading your certificate...`;

                // Load master PDF from cloud
                console.log('Loading master PDF from:', pdfUrl);
                const response = await fetch(pdfUrl);
                
                if (!response.ok) {
                    throw new Error(`Could not load certificate PDF (HTTP ${response.status})`);
                }

                const arrayBuffer = await response.arrayBuffer();
                const masterPdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                
                // Validate page number
                if (pageNumber > masterPdfDoc.getPageCount()) {
                    throw new Error(`Page ${pageNumber} doesn't exist in the certificate PDF`);
                }

                // Extract specific page
                const singlePagePDF = await PDFLib.PDFDocument.create();
                const [copiedPage] = await singlePagePDF.copyPages(masterPdfDoc, [pageNumber - 1]);
                singlePagePDF.addPage(copiedPage);

                // Display the certificate page
                await displayCertificatePage(singlePagePDF, recipientName);

                // Store for download
                window.currentCertificate = {
                    name: recipientName,
                    pageNumber: pageNumber,
                    pdfDoc: singlePagePDF
                };

            } catch (error) {
                console.error('Error loading certificate:', error);
                showCertificateError(error.message);
            }
        }

        async function displayCertificatePage(pdfDoc, recipientName) {
            try {
                // Generate PDF blob
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);

                // Display in iframe
                const viewer = document.getElementById('certificateViewer');
                viewer.innerHTML = `
                    <iframe 
                        src="${url}#toolbar=0&navpanes=0&scrollbar=0" 
                        width="100%" 
                        height="600px" 
                        style="border: none; border-radius: 10px;">
                        <p style="padding: 40px; text-align: center;">
                            Your browser doesn't support PDF viewing. 
                            <a href="${url}" target="_blank" style="color: #667eea;">Click here to download your certificate</a>
                        </p>
                    </iframe>
                `;

                document.getElementById('viewerWelcome').textContent = 
                    `Hello ${recipientName}! Here is your certificate:`;
                
                document.getElementById('downloadBtn').style.display = 'inline-flex';

            } catch (error) {
                throw new Error('Failed to display certificate: ' + error.message);
            }
        }

        function showCertificateError(errorMessage) {
            document.getElementById('viewerWelcome').textContent = 'Certificate Loading Error';
            document.getElementById('certificateViewer').innerHTML = `
                <div style="padding: 40px; text-align: center; color: #666;">
                    <h3 style="color: #dc2626; margin-bottom: 15px;">⚠️ Unable to Load Certificate</h3>
                    <p style="margin-bottom: 20px;"><strong>Error:</strong> ${errorMessage}</p>
                    
                    <div style="background: #fef7ed; border: 1px solid #fed7aa; border-radius: 8px; padding: 20px; margin: 20px 0; text-align: left;">
                        <h4 style="color: #c2410c; margin-bottom: 15px;">💡 Possible Solutions:</h4>
                        <ul style="color: #9a3412; margin-left: 20px; line-height: 1.6;">
                            <li>Check that your link is complete and hasn't been truncated</li>
                            <li>Make sure the certificate PDF is accessible on GitHub Pages</li>
                            <li>Try copying and pasting the full link again</li>
                            <li>Contact the certificate administrator for a new link</li>
                        </ul>
                    </div>
                    
                    <p style="font-size: 14px; color: #888; margin-top: 20px;">
                        This certificate loads from a cloud-hosted PDF. Please ensure the master PDF is publicly accessible.
                    </p>
                </div>
            `;
        }

        async function downloadUserCertificate() {
            if (!window.currentCertificate) {
                alert('Certificate not ready for download');
                return;
            }

            try {
                const pdfBytes = await window.currentCertificate.pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${window.currentCertificate.name.replace(/\s+/g, '_')}_Certificate.pdf`;
                link.click();

            } catch (error) {
                console.error('Download error:', error);
                alert('Error downloading certificate. Please try again.');
            }
        }

        function shareCertificate() {
            const url = window.location.href;
            
            if (navigator.share) {
                navigator.share({
                    title: 'My Certificate',
                    text: 'Check out my certificate!',
                    url: url
                });
            } else {
                copyToClipboard(url);
            }
        }
    </script>
</body>
</html>